name: Manual Release

# Manual release workflow - use when you want to force a specific version
# For automatic releases on push to main, see auto-release.yml
#
# Usage: Go to Actions → Manual Release → Run workflow
# Choose release type: full (Docker + binaries) or binary (binaries only)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
      release_type:
        description: 'Release type'
        required: true
        default: 'full'
        type: choice
        options:
          - full    # Docker images + binaries
          - binary  # Binaries only (for hotfixes)

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Set up Docker Buildx
        if: inputs.release_type == 'full'
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        if: inputs.release_type == 'full'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install cross-compilation dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Build binaries
        run: |
          mkdir -p dist
          VERSION="${{ inputs.version }}"

          # Build linux/amd64 with CGO (native, for SQLite support)
          echo "Building dist/spatialnvr-linux-amd64..."
          CGO_ENABLED=1 GOOS=linux GOARCH=amd64 go build \
            -ldflags="-s -w -X main.Version=$VERSION" \
            -o "dist/spatialnvr-linux-amd64" ./cmd/nvr
          chmod +x "dist/spatialnvr-linux-amd64"

          # Build linux/arm64 with CGO (cross-compile)
          echo "Building dist/spatialnvr-linux-arm64..."
          CGO_ENABLED=1 GOOS=linux GOARCH=arm64 CC=aarch64-linux-gnu-gcc go build \
            -ldflags="-s -w -X main.Version=$VERSION" \
            -o "dist/spatialnvr-linux-arm64" ./cmd/nvr
          chmod +x "dist/spatialnvr-linux-arm64"

          # Darwin builds - CGO disabled (use Docker for production)
          for platform in "darwin/amd64" "darwin/arm64"; do
            GOOS=$(echo $platform | cut -d/ -f1)
            GOARCH=$(echo $platform | cut -d/ -f2)
            OUTPUT="dist/spatialnvr-${GOOS}-${GOARCH}"

            echo "Building $OUTPUT (without CGO - use Docker for production)..."
            CGO_ENABLED=0 GOOS=$GOOS GOARCH=$GOARCH go build \
              -ldflags="-s -w -X main.Version=$VERSION" \
              -o "$OUTPUT" ./cmd/nvr
            chmod +x "$OUTPUT"
          done

          ls -la dist/

      - name: Build and push Docker (amd64)
        if: inputs.release_type == 'full'
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: |
            ghcr.io/spatial-nvr/spatialnvr:${{ inputs.version }}
            ghcr.io/spatial-nvr/spatialnvr:${{ inputs.version }}-amd64
            ghcr.io/spatial-nvr/spatialnvr:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Docker (arm64)
        if: inputs.release_type == 'full'
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/arm64
          push: true
          tags: |
            ghcr.io/spatial-nvr/spatialnvr:${{ inputs.version }}-arm64
            ghcr.io/spatial-nvr/spatialnvr:arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Create tag
        run: |
          VERSION="${{ inputs.version }}"
          if [ "${{ inputs.release_type }}" = "binary" ]; then
            TAG="v${VERSION}-bin"
          else
            TAG="v${VERSION}"
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "Release $TAG" || true
          git push origin "$TAG" || true

          echo "TAG=$TAG" >> $GITHUB_ENV

      - name: Generate changelog
        run: |
          VERSION="${{ inputs.version }}"
          RELEASE_TYPE="${{ inputs.release_type }}"

          if [ "$RELEASE_TYPE" = "full" ]; then
            cat > CHANGELOG.md << EOF
          ## SpatialNVR v$VERSION

          ### Docker Images
          - \`ghcr.io/spatial-nvr/spatialnvr:$VERSION\` (amd64)
          - \`ghcr.io/spatial-nvr/spatialnvr:$VERSION-arm64\` (arm64)

          ### Binaries
          Download the appropriate binary for your platform.
          EOF
          else
            cat > CHANGELOG.md << EOF
          ## SpatialNVR v$VERSION (Binary Release)

          Binary-only release for in-app hot updates.
          No container rebuild required.

          ### Installation
          Replace the binary in \`/data/bin/nvr\` and restart.
          EOF
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: "SpatialNVR v${{ inputs.version }}"
          body_path: CHANGELOG.md
          files: dist/*

      - name: Update versions.json
        run: |
          VERSION="${{ inputs.version }}"
          DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          RELEASE_TYPE="${{ inputs.release_type }}"

          # Read existing versions.json or create new
          if [ -f versions.json ]; then
            CURRENT=$(cat versions.json)
          else
            CURRENT='{"schema_version":"1.0","latest":{},"components":{}}'
          fi

          if [ "$RELEASE_TYPE" = "full" ]; then
            # Update latest version
            cat > versions.json << EOF
          {
            "schema_version": "1.0",
            "latest": {
              "version": "$VERSION",
              "date": "$DATE",
              "docker": {
                "amd64": "ghcr.io/spatial-nvr/spatialnvr:$VERSION",
                "arm64": "ghcr.io/spatial-nvr/spatialnvr:$VERSION-arm64"
              },
              "binaries": {
                "linux-amd64": "https://github.com/Spatial-NVR/SpatialNVR/releases/download/v$VERSION/spatialnvr-linux-amd64",
                "linux-arm64": "https://github.com/Spatial-NVR/SpatialNVR/releases/download/v$VERSION/spatialnvr-linux-arm64",
                "darwin-amd64": "https://github.com/Spatial-NVR/SpatialNVR/releases/download/v$VERSION/spatialnvr-darwin-amd64",
                "darwin-arm64": "https://github.com/Spatial-NVR/SpatialNVR/releases/download/v$VERSION/spatialnvr-darwin-arm64"
              },
              "changelog_url": "https://github.com/Spatial-NVR/SpatialNVR/releases/tag/v$VERSION"
            },
            "components": $(echo "$CURRENT" | jq '.components // {}'),
            "update_check_url": "https://raw.githubusercontent.com/Spatial-NVR/SpatialNVR/main/versions.json"
          }
          EOF
          else
            # Binary-only release - just update binaries URLs
            cat > versions.json << EOF
          {
            "schema_version": "1.0",
            "latest": {
              "version": "$VERSION",
              "date": "$DATE",
              "docker": $(echo "$CURRENT" | jq '.latest.docker // {}'),
              "binaries": {
                "linux-amd64": "https://github.com/Spatial-NVR/SpatialNVR/releases/download/v$VERSION-bin/spatialnvr-linux-amd64",
                "linux-arm64": "https://github.com/Spatial-NVR/SpatialNVR/releases/download/v$VERSION-bin/spatialnvr-linux-arm64",
                "darwin-amd64": "https://github.com/Spatial-NVR/SpatialNVR/releases/download/v$VERSION-bin/spatialnvr-darwin-amd64",
                "darwin-arm64": "https://github.com/Spatial-NVR/SpatialNVR/releases/download/v$VERSION-bin/spatialnvr-darwin-arm64"
              },
              "changelog_url": "https://github.com/Spatial-NVR/SpatialNVR/releases/tag/v$VERSION-bin"
            },
            "components": $(echo "$CURRENT" | jq '.components // {}'),
            "update_check_url": "https://raw.githubusercontent.com/Spatial-NVR/SpatialNVR/main/versions.json"
          }
          EOF
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add versions.json
          git commit -m "Update versions.json to v$VERSION" || true
          git push origin main || true
